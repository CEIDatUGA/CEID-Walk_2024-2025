---
title: "FINAL_CEID_WALK"
output: html_document
date: "2024-12-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)

library(RSocrata)
```

Here is a example of running the CEID-walk model for COVID-19 cases and deaths data.

We initialize the model with some variables and a dataset called tdat.

```{r}

suppressPackageStartupMessages(library(tidyverse))
source("covidhub-common.R") # old functions
source("FluSight.R") # new functions
RNGkind("L'Ecuyer-CMRG")
set.seed(1)

mconfig <- ini::read.ini("model.ini")
eval_string <- function(x){
  str2lang(x) %>% eval()
}
mconfig$model_pars <- map(mconfig$model_pars, eval_string)

# Use systme date as forecast date
forecast_dates <- Sys.Date()
forecast_dates <- Sys.getenv("fdt") %>% as.Date()

forecast_dates
```

Update (2024-11-26): Code chunk below now runs without errors or warnings.

```{r}
rw_forecast <- function(df, fdt, npaths = 100, 
                        h = 4, tailn = Inf, include_drift = FALSE){
  stopifnot(npaths > 0)
  last_end_date <- max(df$target_end_date)
  stopifnot(fdt - last_end_date < lubridate::ddays(3))
  df1 <- df %>% filter(target_end_date <= fdt)
  ## remove oobservations more that 2 sds away from mean
  win <- ts(df1$value) %>% tail(n = max(tailn, 14))
  sigma <- sd(win)
  m <- mean(win)
  is_outlier <- abs(win - m) / (2 * sigma) > 1
  win[is_outlier] <- NA
  y <- tail(win[!is.na(win)], n = tailn)
  stopifnot(length(y) == tailn)
  object <- forecast::naive(y, h = 1)$model
  sim <- matrix(NA, nrow = npaths, ncol = h)
  for (i in 1:npaths) {
    sim[i, ] <- simulate(object, nsim = h, bootstrap = FALSE)
  }
  sim1 <- (sim + abs(sim)) / 2 #to zero out any negative values
  sim_dates <- seq(last_end_date + 7, last_end_date + h *7, by = 7)
  colnames(sim1) <- as.character(sim_dates)
  sim12 <- cbind(Rep = seq_len(nrow(sim1)), sim1) %>% as_tibble()
  simdf <- sim12 %>% pivot_longer(-Rep, names_to = "Date", 
                                  values_to = "value")
  simdf %>% mutate(Date = lubridate::ymd(Date))
}

reshape_paths_like_pompout <- function(x){
  x %>% mutate(target_type = recode(target_type, 
                                    `wk ahead inc death`= "deaths",
                                    `wk ahead inc case` = "cases")) %>% 
    pivot_wider(id_cols = c(Rep, Date), names_from = "target_type", 
                values_from = "value")
}

reshape_paths_2024_2025 <- function(x){
  x %>% 
    # mutate(target_type = recode(target_type, 
    #                                 `wk ahead inc death`= "deaths",
    #                                 `wk ahead inc case` = "cases")) %>% 
    pivot_wider(id_cols = c(Rep, Date), names_from = "target_type", 
                values_from = "value")
}

sim_paths <- function(fdt, tdat, mname, odir, ...) {
  
  tdat1 <- tdat %>% 
    filter(target_type %in% c("wk ahead inc death", "wk ahead inc case")) %>%
    group_by(location, target_type) %>%
    arrange(target_end_date) %>%
    nest() %>% 
    mutate(paths = map(data, rw_forecast, fdt = fdt, ...)) %>%
    select(-data) %>%
    unnest(cols = paths) %>%
    group_by(location) %>%
    nest() %>%
    mutate(paths2 = map(data, reshape_paths_like_pompout)) %>%
    select(-data) %>%
    mutate(fcst_df = map2(paths2, location, paths_to_forecast, hop = tdat, 
                          fdt = fdt))
  
  full <- bind_rows(tdat1$fcst_df)
  
  fname <- paste0(fdt, "-CEID-", mname, ".csv")
  if (!dir.exists(odir)) {
    dir.create(odir)
  }
  opath <- file.path(odir, fname)
  write_csv(full, opath)
}

sim_paths_2024_2025 <- function(fdt, tdat, target_types, mname, odir, ...) {
  
  print(target_types)
  
  tdat1 <- tdat %>% 
    filter(target_type %in% target_types) %>%
    group_by(location, target_type) %>%
    arrange(target_end_date) %>%
    nest() %>% 
    mutate(paths = map(data, rw_forecast, fdt = fdt, ...)) %>%
    select(-data) %>%
    unnest(cols = paths) %>%
    group_by(location) %>%
    nest() %>%
    mutate(paths2 = map(data, reshape_paths_2024_2025)) %>%
    select(-data) %>%
    mutate(fcst_df = map2(paths2, location, paths_to_forecast_2024_2025, 
                          hop = tdat, 
                          fdt = fdt,
                          target_types = target_types))
  
  full <- bind_rows(tdat1$fcst_df)
  
  fname <- paste0(fdt, "-CEID-", mname, ".csv")
  if (!dir.exists(odir)) {
    dir.create(odir)
  }
  opath <- file.path(odir, fname)
  write_csv(full, opath)
}


```

UPDATE (2024-11-16): Now trying with new data format and targets

```{r}

# Locations as defined by cdcepi
locations_file <- "https://raw.githubusercontent.com/cdcepi/FluSight-forecast-hub/refs/heads/main/auxiliary-data/locations.csv"
state_codes <- read_csv(locations_file)


NHSN_names <- read_csv("NHSN_names.csv", show_col_types = FALSE)

```


You need to download preliminary NHSN data from this website:


https://data.cdc.gov/Public-Health-Surveillance/Weekly-Hospital-Respiratory-Data-HRD-Metrics-by-Ju/mpgq-jmmr/about_data.

Move file to the preliminary_data folder.

It gets updated every Wednesday around 1PM.


```{r}

# change the date  to the correct new dataset!!!!!
NHSN_data <- read_csv("weekly_forecasts/preliminary_data/Weekly_Hospital_Respiratory_Data__HRD__Metrics_by_Jurisdiction__National_Healthcare_Safety_Network__NHSN___Preliminary__20241218.csv") %>% 
  as_tibble() %>% 
#  mutate(`Week Ending Date` = as.Date(`Week Ending Date`)) %>% 
  # Impose full names`
#  data.table::setnames(old = NHSN_names$name, new = NHSN_names$full_name) %>% 
  mutate(`Geographic aggregation` = case_when(`Geographic aggregation` == 'USA' ~ 'US',
                                              .default = `Geographic aggregation`)) %>% 
  filter(`Geographic aggregation` %in% state_codes$abbreviation)
```

Final dataset utilized on the forecasting.

```{r}

final_dataframe <- NHSN_data %>%
  # select(`Week Ending Date`, `Geographic aggregation`, `Weekly Total Influenza Admissions`, `Weekly Total COVID-19 Admissions`) %>% #old
  select(target_end_date = `Week Ending Date`,
         abbreviation = `Geographic aggregation`,
         admissions_influenza = `Total Influenza Admissions`,
         admissions_rsv = `Total RSV Admissions`,
         admissions_covid = `Total COVID-19 Admissions`) %>%
  pivot_longer(
    cols = c(admissions_influenza, admissions_rsv, admissions_covid),
    names_to = "target_type",
    values_to = "value"
  ) %>% 
  mutate(value = replace_na(value, 0)) %>%    # Set NA values in 'value' to 0
  # add numeric codes and keep only locations in state_codes
  inner_join(state_codes[c("abbreviation","location")], by = "abbreviation") %>% 
  relocate(location,abbreviation)

head(final_dataframe)
```

UPDATE (2024-12-18):  
To work, this requires the new function `sim_paths_2024_2025` and the functions in `FluSight.R`, 
which are are modified from `covidhub-common.R`.

Now lets forecast for all 53 locations (incl US, Puerto Rico and DC)

```{r}

# Setup the forecast date 
forecast_dates <- max(final_dataframe$target_end_date) # forecast date is the last data of the dataset
forecast_dates

# Split the data by location 
# create nested dataframes to run one at the time similar to the example above

locations_data <- final_dataframe %>%
  group_split(location)


unique(final_dataframe$location)

# Define a helper function to process each location
process_location <- function(location_data) {
  # Filter data for the given location
  filtered_data <- location_data %>%
    filter(target_end_date <= max(forecast_dates))
  
  # Run the simulation
  results <- map(
    forecast_dates,
    sim_paths_2024_2025,
    target_types = "admissions_influenza",
    tdat = filtered_data,
    npaths = mconfig$model_pars$npaths,
    tailn = mconfig$model_pars$tailn,
    include_drift = mconfig$model_pars$include_drift,
    odir = "forecasts",
    mname = "Walk"
  )
  
  return(results)
}

# Apply the process to all locations
all_results <- map(locations_data, process_location)

#Combine all results into a single data frame
combined_results <- all_results %>%
  map_dfr(~bind_rows(.x))

# Organize the output format
colnames(combined_results)<-c("reference_date","target","target_end_date","location","output_type","output_type_id","value") 

# Correct the forecast horizion (0-3) and remove point forecast (keep only quantiles)
combined_results <- combined_results %>%
  filter(output_type != "point") %>%
  mutate(horizon = as.numeric(target_end_date - reference_date) / 7 - 1)%>%
  mutate(reference_date = reference_date+7)
# Final dataframe ready for submission

combined_results$target<-"wk inc flu hosp"

head(combined_results)

```

Write the CSV file with the correct date

```{r}
# write CSV
write_csv(combined_results, file = "weekly_forecasts/UGA_CEID-Walk/2024-12-21-UGA_CEID-Walk.csv")
```

